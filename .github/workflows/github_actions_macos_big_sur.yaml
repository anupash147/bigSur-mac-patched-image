name: Build macOS Big Sur Installer

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'macOS version to build'
        required: true
        default: '11.7.10'
      image_format:
        description: 'ISO or DMG'
        required: true
        default: 'dmg'

jobs:
  build-installer:
    runs-on: macos-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        brew install wget

    - name: Fetch macOS installer
      run: |
        echo "Fetching macOS ${{ github.event.inputs.macos_version }}"
        softwareupdate --fetch-full-installer --full-installer-version ${{ github.event.inputs.macos_version }}

    - name: Convert to DMG/ISO
      run: |
        INSTALLER_APP="/Applications/Install macOS Big Sur.app"
        if [ ! -d "$INSTALLER_APP" ]; then
          echo "Installer app not found!"
          exit 1
        fi
        if [ "${{ github.event.inputs.image_format }}" = "iso" ]; then
          hdiutil convert "$INSTALLER_APP/Contents/SharedSupport/InstallESD.dmg" -format UDTO -o macOS_BigSur.iso
        else
          cp "$INSTALLER_APP/Contents/SharedSupport/InstallESD.dmg" macOS_Installer.dmg
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macOS-BigSur-Installer
        path: |
          macOS_Installer.dmg
          macOS_BigSur.iso
